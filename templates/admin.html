<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Dashboard - SwasthAI</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon_io/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon_io/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon_io/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/favicon_io/apple-touch-icon.png">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #0f766e;
            --accent: #dc2626;
            --dark: #0f172a;
            --success: #10b981;
            --warning: #f59e0b;
        }
        
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: var(--dark);
            color: white;
            padding: 2rem 1rem;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sidebar-brand i {
            color: var(--accent);
        }
        
        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-nav-item {
            margin-bottom: 0.5rem;
        }
        
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: #cbd5e1;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .sidebar-nav-link:hover,
        .sidebar-nav-link.active {
            background: rgba(59, 130, 246, 0.1);
            color: white;
        }
        
        .sidebar-nav-link i {
            font-size: 1.2rem;
        }
        
        .main-content {
            margin-left: 260px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .stat-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon.primary {
            background: #eff6ff;
            color: var(--primary);
        }
        
        .stat-card-icon.success {
            background: #f0fdf4;
            color: var(--success);
        }
        
        .stat-card-icon.warning {
            background: #fef3c7;
            color: var(--warning);
        }
        
        .stat-card-icon.accent {
            background: #fef2f2;
            color: var(--accent);
        }
        
        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }
        
        .stat-card-label {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .users-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead {
            background: #f8fafc;
        }
        
        .badge-admin {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-user {
            background: #e2e8f0;
            color: #475569;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .btn-action {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        
        .chat-message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .chat-message.user {
            background: #eff6ff;
            border-left: 3px solid var(--primary);
        }
        
        .chat-message.assistant {
            background: #f0fdf4;
            border-left: 3px solid var(--success);
        }
        
        .chat-message-role {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .chat-message-time {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner-border {
            color: var(--primary);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-brand">
            <i class="bi bi-heart-pulse-fill"></i>
            <span>SwasthAI Admin</span>
        </div>
        
        <ul class="sidebar-nav">
            <li class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link active" onclick="showDashboard(); return false;">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link" onclick="showUsers(); return false;">
                    <i class="bi bi-people-fill"></i>
                    <span>Users</span>
                </a>
            </li>
            <li class="sidebar-nav-item">
                <a href="/" class="sidebar-nav-link">
                    <i class="bi bi-house-fill"></i>
                    <span>Back to Home</span>
                </a>
            </li>
            <li class="sidebar-nav-item mt-4">
                <a href="#" class="sidebar-nav-link" onclick="logout(); return false;">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard View -->
        <div id="dashboardView">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">Admin Dashboard</h2>
                    <p class="text-muted">Overview of SwasthAI platform</p>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="row g-4 mb-4" id="statsCards">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-card-icon primary">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="stat-card-value" id="totalUsers">--</div>
                        <div class="stat-card-label">Total Users</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-card-icon success">
                            <i class="bi bi-chat-dots-fill"></i>
                        </div>
                        <div class="stat-card-value" id="totalMessages">--</div>
                        <div class="stat-card-label">Total Messages</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-card-icon warning">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>
                        <div class="stat-card-value" id="newUsers">--</div>
                        <div class="stat-card-label">New Users (7d)</div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-card-icon accent">
                            <i class="bi bi-bar-chart-fill"></i>
                        </div>
                        <div class="stat-card-value" id="avgMessages">--</div>
                        <div class="stat-card-label">Avg Messages/User</div>
                    </div>
                </div>
            </div>
            
            <!-- Users Table Preview -->
            <div class="users-table">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th colspan="6" class="p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Recent Users</h5>
                                        <button class="btn btn-sm btn-primary" onclick="showUsers()">
                                            View All <i class="bi bi-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </th>
                            </tr>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Role</th>
                                <th>Messages</th>
                                <th>Joined</th>
                            </tr>
                        </thead>
                        <tbody id="recentUsersTable">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm"></div>
                                    <span class="ms-2">Loading users...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Users View -->
        <div id="usersView" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">All Users</h2>
                    <p class="text-muted">Manage platform users</p>
                </div>
                <button class="btn btn-outline-primary" onclick="showDashboard()">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </button>
            </div>
            
            <div class="users-table">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Role</th>
                                <th>Total Messages</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allUsersTable">
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="spinner-border"></div>
                                    <p class="mt-2">Loading users...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Messages Modal -->
    <div class="modal fade" id="messagesModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-chat-dots me-2"></i>
                        User Chat History
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="messagesContent">
                    <div class="loading">
                        <div class="spinner-border"></div>
                        <p class="mt-2">Loading messages...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirm Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Confirm Delete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                    <p class="mb-0"><strong>User: </strong><span id="deleteUserName"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete User</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        let currentDeleteUserId = null;
        
        // Check authentication on load
        window.addEventListener('load', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login?redirect=admin';
                return;
            }
            
            // Verify admin access
            try {
                const response = await fetch(`${API_BASE}/user`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Unauthorized');
                }
                
                const user = await response.json();
                if (!user.is_admin) {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '/';
                    return;
                }
                
                // Load dashboard data
                await loadStats();
                await loadUsers();
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('token');
                window.location.href = '/login?redirect=admin';
            }
        });
        
        // Load statistics
        async function loadStats() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load stats');
                
                const stats = await response.json();
                document.getElementById('totalUsers').textContent = stats.total_users;
                document.getElementById('totalMessages').textContent = stats.total_messages;
                document.getElementById('newUsers').textContent = stats.new_users_this_week;
                document.getElementById('avgMessages').textContent = stats.avg_messages_per_user;
            } catch (error) {
                console.error('Stats error:', error);
            }
        }
        
        // Load all users
        async function loadUsers() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load users');
                
                const data = await response.json();
                displayUsers(data.users);
            } catch (error) {
                console.error('Users error:', error);
            }
        }
        
        // Display users in tables
        function displayUsers(users) {
            const recentTable = document.getElementById('recentUsersTable');
            const allTable = document.getElementById('allUsersTable');
            
            if (users.length === 0) {
                const emptyRow = '<tr><td colspan="6" class="text-center py-4">No users found</td></tr>';
                recentTable.innerHTML = emptyRow;
                allTable.innerHTML = emptyRow.replace('6', '7');
                return;
            }
            
            // Recent users (first 5)
            recentTable.innerHTML = users.slice(0, 5).map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.full_name}</td>
                    <td>
                        <span class="badge-${user.is_admin ? 'admin' : 'user'}">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td>${user.total_messages}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
            
            // All users
            allTable.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.full_name}</td>
                    <td>
                        <span class="badge-${user.is_admin ? 'admin' : 'user'}">
                            ${user.is_admin ? 'Admin' : 'User'}
                        </span>
                    </td>
                    <td>${user.total_messages}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary btn-action" onclick="viewMessages(${user.id}, '${user.username}')">
                            <i class="bi bi-chat-dots"></i> View Chats
                        </button>
                        ${!user.is_admin ? `
                        <button class="btn btn-sm btn-danger btn-action ms-1" onclick="deleteUser(${user.id}, '${user.username}')">
                            <i class="bi bi-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        // View user messages
        async function viewMessages(userId, username) {
            const token = localStorage.getItem('token');
            const modal = new bootstrap.Modal(document.getElementById('messagesModal'));
            const content = document.getElementById('messagesContent');
            
            content.innerHTML = '<div class="loading"><div class="spinner-border"></div><p class="mt-2">Loading messages...</p></div>';
            modal.show();
            
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load messages');
                
                const data = await response.json();
                
                if (data.messages.length === 0) {
                    content.innerHTML = '<p class="text-center text-muted py-4">No messages yet</p>';
                    return;
                }
                
                content.innerHTML = `
                    <div class="mb-3">
                        <h6>User: ${data.user.full_name} (@${data.user.username})</h6>
                        <p class="text-muted mb-0">Total Messages: ${data.total_messages}</p>
                    </div>
                    <hr>
                    ${data.messages.map(msg => `
                        <div class="chat-message ${msg.role}">
                            <div class="chat-message-role">${msg.role === 'user' ? 'ðŸ‘¤ User' : 'ðŸ¤– Assistant'}</div>
                            <div class="chat-message-time">${new Date(msg.created_at).toLocaleString()}</div>
                            <div>${msg.content}</div>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                console.error('Messages error:', error);
                content.innerHTML = '<p class="text-center text-danger py-4">Failed to load messages</p>';
            }
        }
        
        // Delete user
        function deleteUser(userId, username) {
            currentDeleteUserId = userId;
            document.getElementById('deleteUserName').textContent = username;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }
        
        async function confirmDelete() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/admin/users/${currentDeleteUserId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Delete failed');
                
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                await loadStats();
                await loadUsers();
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete user');
            }
        }
        
        // Navigation
        function showDashboard() {
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('usersView').style.display = 'none';
            document.querySelectorAll('.sidebar-nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav-link')[0].classList.add('active');
        }
        
        function showUsers() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('usersView').style.display = 'block';
            document.querySelectorAll('.sidebar-nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav-link')[1].classList.add('active');
        }
        
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }
    </script>
</body>
</html>
